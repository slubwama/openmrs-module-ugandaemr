<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
                  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">
    <!--
        See http://www.liquibase.org/manual/home#available_database_refactorings
        for a list of supported elements and attributes
    -->

	<changeSet id="ugandaemr-27112020-1441" author="ssmusoke">
		<preConditions onFail="MARK_RAN" onError="MARK_RAN">
			<sqlCheck expectedResult="100">
				SELECT property_value
				FROM global_property
				WHERE property = 'ugandaemr.maximumPatientsPerDay'
			</sqlCheck>
		</preConditions>
		<comment>Reset maximum patients per day value to blank which is unlimited</comment>
		<sql>UPDATE global_property SET property_value = '' WHERE property = 'ugandaemr.maximumPatientsPerDay'</sql>
	</changeSet>

	<changeSet id="ugandaemr-05092018-1043" author="ssmusoke">
		<comment>Fix bad data for the ART care section which is causing an error when saving the summary page</comment>
		<sql>
			UPDATE obs SET value_numeric = NULL WHERE concept_id = 99162 AND value_numeric IS NOT NULL;
		</sql>
	</changeSet>
	<changeSet id="ugandaemr-19072018-1002" author="ssmusoke">
		<comment>Correct the sticky note concept</comment>
		<sql>
			UPDATE global_property SET property_value = 'CIEL:162169' WHERE property = 'coreapps.conceptStickyNote';
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-07052017-1505" author="ssmusoke">
		<comment>Move the death information from the obs table to the person table</comment>
		<sql>
			UPDATE person INNER JOIN obs ON obs.person_id = person.person_id AND concept_id = 99112 AND value_coded = 90003 SET dead = 1;
			UPDATE person INNER JOIN obs ON obs.person_id = person.person_id AND concept_id = 90272 SET death_date = value_datetime;
		</sql>
	</changeSet>
	<changeSet id="ugandaemr-09262017-2245" author="ssmusoke">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				SELECT count(form_id) FROM form WHERE form_id = 14
			</sqlCheck>
		</preConditions>
		<comment>Move all summary pages from form_id 34 to 14</comment>
		<sql>UPDATE encounter SET form_id = 14 WHERE form_id = 34</sql>
	</changeSet>
	<changeSet id="ugandaemr-07112017-1757" author="ssmusoke">
		<comment>Delete obs without concepts from previous migrations</comment>
		<sql>
			DELETE FROM obs WHERE concept_id IN (SELECT c.concept_id FROM concept c WHERE c.datatype_id = 2) AND value_coded IS NULL
		</sql>
	</changeSet>
	<changeSet id="ugandaemr-06272017-2053" author="ssmusoke">
		<comment>Delete corrupted metadata mapping terms from xstream 2.07 and lower for Encounter Types</comment>
		<sql>
			UPDATE metadatamapping_metadata_term_mapping SET metadata_class = 'org.openmrs.EncounterType' WHERE metadata_class = 'org.openmrs.EncounterType_$$_jvstbd5_23'
		</sql>
	</changeSet>


	<changeSet id="35ef129f-2b7f-4d17-a0b2-d305327c8fde" author="solemabrothers">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				SELECT COUNT(*) FROM scheduler_task_config  WHERE uuid = '415b8d70-6b45-41d8-a0ba-41b1a6b8aa1f'
			</sqlCheck>
		</preConditions>
		<comment>Clear the tasks named aijar</comment>
			<sql>
				Delete  from liquibasechangelog where ID in ('ugandaemr-06232017-1639','ugandaemr-06232017-1638','ugandaemr-06232017-1637','uganademr-10202017-2138','551c4d8d-8d33-4bcf-bee7-5aeeadc47775','ugandaemr-2019-16-16-1425');
			</sql>
	</changeSet>

	<changeSet id="ugandaemr-08022021-3" author="ssmusoke">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.ugandaemr.tasks.LinkExposedInfantToMotherTask'
            </sqlCheck>
		</preConditions>
		<comment>Inserting Exposed Infant Link to Mother Task into 'schedule_task_config' table</comment>
		<sql>DELETE FROM scheduler_task_config where uuid='29584cdf-37c0-46ec-b942-3b98274e30d8'</sql>
		<insert tableName="scheduler_task_config">
			<column name="name" value="Link infants to mothers via ART Number" />
			<column name="description" value="Links exposed infants to mothers through their ART numbers" />
			<column name="schedulable_class" value="org.openmrs.module.ugandaemr.tasks.LinkExposedInfantToMotherTask" />
			<column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
			<column name="start_time" valueDate="2017-06-01T11:59:59" />
			<column name="repeat_interval" value="86400" />
			<column name="date_created" valueDate="CURRENT_TIMESTAMP" />
			<column name="created_by" value="1" />
			<column name="start_on_startup" value="1"/>
			<column name="started" value="1"/>
			<column name="uuid" value="29584cdf-37c0-46ec-b942-3b98274e30d8" />
		</insert>

	</changeSet>
	<changeSet id="ugandaemr-08022021-2" author="ssmusoke">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.ugandaemr.tasks.ExitTBProgramASLostToFollowUpTask'
            </sqlCheck>
		</preConditions>
		<sql>DELETE FROM scheduler_task_config where uuid='415b8d70-6b45-41d8-a0ba-41b1a6b8aa1f'</sql>
		<comment>Inserting TB Lost to Followup Exit Task into 'schedule_task_config' table</comment>
		<insert tableName="scheduler_task_config">
			<column name="name" value="TB Lost to Followup Exit Task" />
			<column name="description" value="Exits patients from the TB program who have not come for 90 days" />
			<column name="schedulable_class" value="org.openmrs.module.ugandaemr.tasks.ExitTBProgramASLostToFollowUpTask" />
			<column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
			<column name="start_time" valueDate="2017-06-01T11:59:59" />
			<column name="repeat_interval" value="86400" />
			<column name="date_created" valueDate="CURRENT_TIMESTAMP" />
			<column name="created_by" value="1" />
			<column name="start_on_startup" value="1"/>
			<column name="started" value="1"/>
			<column name="uuid" value="415b8d70-6b45-41d8-a0ba-41b1a6b8aa1f" />
		</insert>

	</changeSet>
	<changeSet id="ugandaemr-08022021-1" author="ssmusoke">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.ugandaemr.tasks.ExitMCHProgramASLostToFollowUpTask'
            </sqlCheck>
		</preConditions>
		<sql>DELETE FROM scheduler_task_config where uuid='d1147982-1fd3-4d03-8b6c-6345a8187b28'</sql>
		<comment>Inserting MCH Lost to Followup Exit Task into 'schedule_task_config' table</comment>
		<insert tableName="scheduler_task_config">
			<column name="name" value="MCH Lost to Followup Exit Task" />
			<column name="description" value="Exits mothers from the MCH program who have not come for 90 days" />
			<column name="schedulable_class" value="org.openmrs.module.ugandaemr.tasks.ExitMCHProgramASLostToFollowUpTask" />
			<column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
			<column name="start_time" valueDate="2017-06-01T11:59:59" />
			<column name="repeat_interval" value="86400" />
			<column name="date_created" valueDate="CURRENT_TIMESTAMP" />
			<column name="created_by" value="1" />
			<column name="start_on_startup" value="1"/>
			<column name="started" value="1"/>
			<column name="uuid" value="d1147982-1fd3-4d03-8b6c-6345a8187b28" />
		</insert>

	</changeSet>
    <changeSet id="ugandaemr-12162016-1052" author="ssmusoke">
		<comment>Stop scheduled tasks that are not used from starting up</comment>
		<sql>
			UPDATE scheduler_task_config SET start_on_startup = 0 WHERE schedulable_class IN ('org.openmrs.module.formentry.ProcessFormEntryQueueTask', 'org.openmrs.scheduler.tasks.ProcessHL7InQueueTask')
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-111032017-1130" author="slubwama">
		<comment>Change concept 162394 datatype to coded concept</comment>
		<sql>
			UPDATE concept SET datatype_id = 2 WHERE concept_id = 162394
		</sql>
	</changeSet>
	<changeSet id="ugandaemr-1712020-1056" author="slubwama">
		<comment>Change birth weight concept 5916 attribute allow decimals to yes</comment>
		<sql>
			UPDATE concept_numeric SET allow_decimal = 1 WHERE concept_id = 5916
		</sql>
	</changeSet>
	<changeSet id="ugandaemr-190920178-0923" author="carapai">
		<comment>Migrate obs date time to viral load date concept</comment>
		<sql>
			INSERT INTO obs (person_id, concept_id, encounter_id, order_id, obs_datetime, location_id, obs_group_id, accession_number, value_group_id, value_coded, value_coded_name_id, value_drug, value_datetime, value_numeric, value_modifier, value_text, value_complex, comments, creator, date_created, voided, voided_by, date_voided, void_reason, uuid, previous_version, form_namespace_and_path)
			SELECT
			person_id,
			163023,
			encounter_id,
			order_id,
			obs_datetime,
			location_id,
			obs_group_id,
			accession_number,
			value_group_id,
			value_coded,
			value_coded_name_id,
			value_drug,
			obs_datetime,
			value_numeric,
			value_modifier,
			value_text,
			value_complex,
			comments,
			creator,
			date_created,
			voided,
			voided_by,
			date_voided,
			void_reason,
			uuid(),
			previous_version,
			form_namespace_and_path
			FROM obs
			WHERE concept_id = 856 AND obs_id NOT IN (SELECT A.obs_id
			FROM
			(SELECT *
			FROM obs
			WHERE concept_id = 856) A INNER JOIN (SELECT *
			FROM obs
			WHERE concept_id = 163023) B
			ON (A.encounter_id = B.encounter_id));
		</sql>
	</changeSet>
    <changeSet id="uganademr-10202017-2138" author="ssmusoke">
		<preConditions onFail="MARK_RAN">
		<sqlCheck expectedResult="0">
            SELECT COUNT(*) FROM scheduler_task_config
            WHERE schedulable_class = 'org.openmrs.module.ugandaemr.tasks.ExitMCHProgramASLostToFollowUpTask'
        </sqlCheck>
		</preConditions>
        <comment>Change column to utf8 to enable saving of multi-byte characters</comment>
        <sql>
            ALTER TABLE `serialized_object` MODIFY `serialized_data` MEDIUMTEXT CHARACTER SET utf8 NOT NULL;
        </sql>
    </changeSet>
	<changeSet id="ugandaemr-28022018-1624" author="ssmusoke">
		<comment>Delete any blank person attribute values from previous upgrades which prevents editing of patient</comment>
		<sql>
			DELETE FROM person_attribute WHERE value IS NULL OR value = '';
		</sql>
	</changeSet>
	<changeSet id="ugandaemr-2024-04-07-0700" author="slubwama">
        <preConditions onFail="CONTINUE">
            <sqlCheck expectedResult="1">
                SELECT COUNT(program_id) FROM program  WHERE program.uuid = 'de5d54ae-c304-11e8-9ad0-529269fb1459';
            </sqlCheck>
			<sqlCheck expectedResult="0">
				SELECT count(id) FROM liquibasechangelog  WHERE id="ugandaemr-01-10-2018-1200";
            </sqlCheck>
        </preConditions>
		<comment>Move all Patients Ever enrolled in Facility Based Individual Management DSDM </comment>
		<sql>
			INSERT INTO patient_program (patient_id, program_id, date_enrolled, location_id, creator, date_created, voided, uuid)
			SELECT patient_id,(SELECT program.program_id FROM program WHERE program.uuid='de5d54ae-c304-11e8-9ad0-529269fb1459') AS program,MAX(encounter_datetime) AS date_enrolled,MAX(location_id),MAX(encounter.creator),NOW(),0,UUID() AS uuid FROM encounter INNER JOIN encounter_type ON(encounter_type.encounter_type_id=encounter.encounter_type) WHERE  encounter_type.uuid='8d5b27bc-c2cc-11de-8d13-0010c6dffd0f' GROUP BY patient_id;
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-01042019-2012" author="dbaluku">
		<comment>Setting  modules to FHIR,Data Entry Statistics to be started manually</comment>
		<sql>
			UPDATE global_property SET property_value = 'false' WHERE property IN ('fhir.started', 'dataentrystatistics.started');
		</sql>
	</changeSet>

    <changeSet id="ugandaemr-25072019-2019" author="slubwama">
        <comment>Setting  modules for Data Entry Statistics to be started automatically</comment>
        <sql>
            UPDATE global_property SET property_value = 'true' WHERE property ='dataentrystatistics.started';
        </sql>
    </changeSet>

    <changeSet id="ugandaemr-25072019-1409" author="slubwama">
        <comment>
			Changing Concept Name for concept 99610 from SMS care entry to SMC care entry
			Changing Concept Description to change SMS word to SMC Word
		</comment>
        <sql>
			UPDATE concept SET short_name = 'SMC' WHERE concept_id =99610;
            UPDATE concept_name SET name = 'SMC care entry' WHERE concept_id =99610;
            UPDATE concept_description SET description = 'SMC as HIV care entry point - This concept added to support MOH ART card functionality' WHERE concept_id =99610;
        </sql>
    </changeSet>

	<changeSet id="ugandaemr-08022021-5" author="dbaluku">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.ugandaemr.tasks.GenerateUniqueIdentifierCodeTask'
            </sqlCheck>
		</preConditions>
		<sql>DELETE FROM scheduler_task_config where uuid='d356a6fd-8426-40d4-9cf2-13d699c6cbc3'</sql>
		<comment>Inserting Unique identifier code in patient identifier table</comment>
		<insert tableName="scheduler_task_config">
			<column name="name" value="UIC_generator_task" />
			<column name="description" value="generates_uics into patient identifier table" />
			<column name="schedulable_class" value="org.openmrs.module.ugandaemr.tasks.GenerateUniqueIdentifierCodeTask" />
			<column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
			<column name="start_time" valueDate="2019-11-08T11:59:59" />
			<column name="repeat_interval" value="86400" />
			<column name="date_created" valueDate="CURRENT_TIMESTAMP" />
			<column name="created_by" value="1" />
			<column name="start_on_startup" value="1"/>
			<column name="started" value="1"/>
			<column name="uuid" value="d356a6fd-8426-40d4-9cf2-13d699c6cbc3" />
		</insert>

	</changeSet>

	<changeSet id="ugandaemr-08022021-7" author="slubwama">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.ugandaemr.tasks.StopActiveFacilityVisitTask'
            </sqlCheck>
		</preConditions>
		<comment>Close all active facility visits</comment>
		<sql>DELETE FROM scheduler_task_config where uuid='1434dd72-1ff7-11ea-978f-2e728ce88125'</sql>
		<insert tableName="scheduler_task_config">
			<column name="name" value="Close Active Facility Visits" />
			<column name="description" value="generates_uics into patient identifier table" />
			<column name="schedulable_class" value="org.openmrs.module.ugandaemr.tasks.StopActiveFacilityVisitTask" />
			<column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
			<column name="start_time" valueDate="2019-11-08T16:59:59" />
			<column name="repeat_interval" value="86400" />
			<column name="date_created" valueDate="CURRENT_TIMESTAMP" />
			<column name="created_by" value="1" />
			<column name="start_on_startup" value="1"/>
			<column name="started" value="1"/>
			<column name="uuid" value="1434dd72-1ff7-11ea-978f-2e728ce88125" />
		</insert>
	</changeSet>

    <changeSet id="ugandaemr-08022021-4" author="slubwama">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.ugandaemr.tasks.MigrateARTPatientTransfersTask'
            </sqlCheck>
        </preConditions>
		<sql>DELETE FROM scheduler_task_config where uuid='8b5caeea-2c3b-11e8-b467-0ed5f89f718b'</sql>
		<comment>Inserting ART Summary Patient Transfer Migration into 'schedule_task_config' table</comment>
        <insert tableName="scheduler_task_config">
            <column name="name" value="ART Summary Patient Transfer Migration" />
            <column name="description" value="Migrates Patients Transfer Data and Created a new Transfer out encounter" />
            <column name="schedulable_class" value="org.openmrs.module.ugandaemr.tasks.MigrateARTPatientTransfersTask" />
            <column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
            <column name="start_time" valueDate="2018-03-20T12:59:59" />
            <column name="repeat_interval" value="86400" />
            <column name="date_created" valueDate="CURRENT_TIMESTAMP" />
            <column name="created_by" value="1" />
            <column name="start_on_startup" value="0"/>
            <column name="started" value="1"/>
            <column name="uuid" value="8b5caeea-2c3b-11e8-b467-0ed5f89f718b" />
        </insert>
    </changeSet>


	<changeSet id="ugandaemr-08-08-2020-1155" author="mmwanje">
		<preConditions onFail="CONTINUE">
			<sqlCheck expectedResult="1">
				SELECT COUNT(*) FROM
				metadatamapping_metadata_set_member WHERE uuid ='e1731641-30ab-102d-86b0-7a5022ba4115';
			</sqlCheck>
		</preConditions>
		<comment> Enabling ART clinic number to be displayed in UgandaEMR on a patient dashboard </comment>
		<sql>
            REPLACE INTO metadatamapping_metadata_set_member (metadata_set_member_id, metadata_set_id, metadata_class, metadata_uuid, sort_weight, name, description, creator, date_created, changed_by, date_changed, retired, date_retired, retired_by, retire_reason, uuid)
            SELECT 1, 1, 'org.openmrs.PatientIdentifierType', 'e1731641-30ab-102d-86b0-7a5022ba4115',null, null, null, 2, NOW(), null, null, 0, null, null, null,'57c7a9df-193d-4d44-b34a-3156e6204bde';
		</sql>
	</changeSet>

	<changeSet author="rmakoba" id="ugandaemr-04052020-iss-9">
		<preConditions onFail="MARK_RAN">
				<not><tableExists tableName="public_holiday"/></not>
		</preConditions>
		<comment>
			Create the public_holiday table
		</comment>
        <createTable tableName="public_holiday">
            <column autoIncrement="true" name="public_holiday_id" type="INT">
                <constraints primaryKey="true"/>
            </column>
            <column  name="public_holiday_date" type="date">
                <constraints nullable="false" unique="true"/>
            </column>
			<column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="VARCHAR(255)">
                <constraints nullable="true"/>
            </column>
            <column name="creator" type="INT"/>
            <column name="date_created" type="datetime"/>
            <column name="changed_by" type="INT"/>
            <column name="date_changed" type="datetime"/>
            <column name="voided" type="TINYINT(3)"/>
            <column name="date_voided" type="datetime"/>
            <column name="voided_by" type="INT"/>
            <column name="void_reason" type="VARCHAR(255)"/>
            <column name="uuid" type="VARCHAR(38)"/>
        </createTable>
    </changeSet>

	<changeSet id="ugandaemr-17052020-iss-9" author="rmakoba">
		<preConditions onFail="CONTINUE">
				<tableExists tableName="public_holiday"/>
		</preConditions>
		<comment>
			Inserting Public holidays
		</comment>
		<sql>
        REPLACE INTO `public_holiday`
(`public_holiday_id`, `public_holiday_date`, `name`, `description`, `date_created`, `creator`, `voided`, `uuid`)
VALUES
(1,'2020-01-01','New Year’s Day','New Year’s Day is the first day of the year, or January 1, in the Gregorian calendar.','2020-06-17 00:00:00',1,0,'ce864849-abdf-4b29-9e99-a62c861f8543'),
(2,'2020-01-26','Liberation Day','Liberation Day is a public holiday in Uganda','2020-06-17 00:00:00',1,0,'c49a70f2-ea66-42f9-bc4a-c5f876542615'),
(3,'2020-02-16','Archbishop Janani Luwum Day','Remembrance of Archbishop Janani Luwum is a public holiday in Uganda','2020-06-17 00:00:00',1,0,'44800c9b-3995-4876-810a-22dada404da9'),
(4,'2020-03-08','International Women’s Day','International Women’s Day is a public holiday in Uganda','2020-06-17 00:00:00',1,0,'4d34541a-f50c-4337-b870-8eede8dcec6f'),
(5,'2020-04-10','Good Friday','Good Friday is a global Christian observance two days before Easter Sunday.','2020-06-17 00:00:00',1,0,'98080bc2-689c-46f3-9b36-04ce4a71a58c'),
(6,'2020-04-12','Easter Sunday','Easter Sunday commemorates Jesus Christ’s resurrection, according to Christian belief.','2020-06-17 00:00:00',1,0,'0a5f810c-5488-4fcb-b8dd-830cda188648'),
(7,'2020-04-13','Easter Monday','Easter Monday is the day after Easter Sunday.','2020-06-17 00:00:00',1,0,'cdc59214-de1a-4808-8faa-4079c6db7cde'),
(8,'2020-05-01','Labour Day','May Day, or Labor Day, is a day off for workers in many countries around the world.','2020-06-17 00:00:00',1,0,'da4d2ca5-2b4c-4111-b77b-812d536885bb'),
(9,'2020-05-24','Eid al-Fitr','Eid-al-Fitr is a holiday to mark the end of the Islamic month of Ramadan, during which Muslims fast during the hours of daylight.','2020-06-17 00:00:00',1,0,'667bad10-aa39-4317-b5e9-4e7b08251cc7'),
(10,'2020-06-03','Martyr’s Day','Martyr’s Day is a public holiday in Uganda','2020-06-17 00:00:00',1,0,'69f66b76-6734-4eb7-af31-79b0b60484ec'),
(11,'2020-06-09','National Heroes Day','National Heroes Day is a public holiday in Uganda','2020-06-17 00:00:00',1,0,'e98240f6-462d-4b24-9d65-1102bc37c1fd'),
(12,'2020-07-31','Eid al-Adha','Eid al-Adha (Id ul-Adha) is an Islamic festival falling on the 10th day of the month of Dhul Hijja (Thou al-Hijja) to commemorate the willingness of Ibrahim (Abraham) to sacrifice his son.','2020-06-17 00:00:00',1,0,'b83a3a67-4228-40d3-8d53-ea49f9fca494'),
(13,'2020-10-09','Independence Day','Independence Day is a public holiday in Uganda','2020-06-17 00:00:00',1,0,'bc489c90-b9eb-48e7-84e7-82cd6bc8857a'),
(14,'2020-12-25','Christmas Day','Christmas Day is one of the biggest Christian celebrations and falls on December 25 in the Gregorian calendar.','2020-06-17 00:00:00',1,0,'2355affe-690e-4ace-bdb7-a22bc71b8ede'),
(15,'2020-12-26','Boxing Day','Boxing Day is a public holiday in Uganda','2020-06-17 00:00:00',1,0,'4bc8db62-6a50-431d-ab44-91493e6ed32d'),

(16,'2021-01-01','New Year’s Day','New Year’s Day is the first day of the year, or January 1, in the Gregorian calendar.','2020-06-17 00:00:00',1,0,'ce864849-abdf-4b29-9e99-a62c861f8543'),
(17,'2021-01-26','Liberation Day','Liberation Day is a public holiday in Uganda','2020-06-17 00:00:00',1,0,'c49a70f2-ea66-42f9-bc4a-c5f876542615'),
(18,'2021-02-16','Archbishop Janani Luwum Day','Remembrance of Archbishop Janani Luwum is a public holiday in Uganda','2020-06-17 00:00:00',1,0,'44800c9b-3995-4876-810a-22dada404da9'),
(19,'2021-03-08','International Women’s Day','International Women’s Day is a public holiday in Uganda','2020-06-17 00:00:00',1,0,'32f24eac-09b5-4edc-94a0-b1ba0b205e2a'),
(20,'2021-04-02','Good Friday','Good Friday is a global Christian observance two days before Easter Sunday.','2020-06-17 00:00:00',1,0,'98080bc2-689c-46f3-9b36-04ce4a71a58c'),
(21,'2021-04-04','Easter Sunday','Easter Sunday commemorates Jesus Christ’s resurrection, according to Christian belief.','2020-06-17 00:00:00',1,0,'0a5f810c-5488-4fcb-b8dd-830cda188648'),
(22,'2021-04-05','Easter Monday','Easter Monday is the day after Easter Sunday.','2020-06-17 00:00:00',1,0,'cdc59214-de1a-4808-8faa-4079c6db7cde'),
(23,'2021-05-01','Labour Day','May Day, or Labor Day, is a day off for workers in many countries around the world.','2020-06-17 00:00:00',1,0,'da4d2ca5-2b4c-4111-b77b-812d536885bb'),
(24,'2021-05-13','Eid al-Fitr','Eid-al-Fitr is a holiday to mark the end of the Islamic month of Ramadan, during which Muslims fast during the hours of daylight.','2020-06-17 00:00:00',1,0,'667bad10-aa39-4317-b5e9-4e7b08251cc7'),
(25,'2021-06-03','Martyr’s Day','Martyr’s Day is a public holiday in Uganda','2020-06-17 00:00:00',1,0,'69f66b76-6734-4eb7-af31-79b0b60484ec'),
(26,'2021-06-09','National Heroes Day','National Heroes Day is a public holiday in Uganda','2020-06-17 00:00:00',1,0,'e98240f6-462d-4b24-9d65-1102bc37c1fd'),
(27,'2021-07-20','Eid al-Adha','Eid al-Adha (Id ul-Adha) is an Islamic festival falling on the 10th day of the month of Dhul Hijja (Thou al-Hijja) to commemorate the willingness of Ibrahim (Abraham) to sacrifice his son.','2020-06-17 00:00:00',1,0,'b83a3a67-4228-40d3-8d53-ea49f9fca494'),
(28,'2021-10-09','Independence Day','Independence Day is a public holiday in Uganda','2020-06-17 00:00:00',1,0,'bc489c90-b9eb-48e7-84e7-82cd6bc8857a'),
(29,'2021-12-25','Christmas Day','Christmas Day is one of the biggest Christian celebrations and falls on December 25 in the Gregorian calendar.','2020-06-17 00:00:00',1,0,'2355affe-690e-4ace-bdb7-a22bc71b8ede'),
(30,'2021-12-26','Boxing Day','Boxing Day is a public holiday in Uganda','2020-06-17 00:00:00',1,0,'4bc8db62-6a50-431d-ab44-91493e6ed32d');
    </sql>
	</changeSet>

	<changeSet id="ugandaemr-10072020-1433" author="mmwanje">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				SELECT COUNT(*) from role WHERE uuid ='130106e6-04b4-11ea-8d71-362b9e155667'
			</sqlCheck>
		</preConditions>
		<comment>Removing the duplicated organizational phamarcy role</comment>
		<sql>
			DELETE FROM user_role WHERE role IN (SELECT role FROM role WHERE uuid = '130106e6-04b4-11ea-8d71-362b9e155667');
			DELETE FROM role WHERE uuid ='130106e6-04b4-11ea-8d71-362b9e155667';
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-08212020-1258" author="dbaluku">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				SELECT COUNT(*) from concept_numeric WHERE concept_id = 851 and allow_decimal = 0
			</sqlCheck>
		</preConditions>
		<comment>Changing of CBC concept to allow decimal results</comment>
		<sql>
			UPDATE concept_numeric SET allow_decimal = 1 WHERE concept_id = 851
		</sql>
	</changeSet>
	<changeSet id="ugandaemr-081509-1604" author="ssmusoke">
		<comment>Delete all existing notification alerts</comment>
		<sql>
			DELETE FROM notification_alert_recipient;
			DELETE FROM notification_alert;
		</sql>
	</changeSet>
	<changeSet id="ugandaemr-05-11-2019" author="slubwama">
		<preConditions onFail="CONTINUE">
			<sqlCheck expectedResult="1">
				SELECT  count(property) from global_property WHERE property='order.testSpecimenSourcesConceptUuid';
			</sqlCheck>
		</preConditions>
		<comment>Setting Specimen source concept uuid</comment>
		<sql>
			UPDATE global_property SET property_value = '162476AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' WHERE property='order.testSpecimenSourcesConceptUuid';
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-12-02-2020-01" author="slubwama">
		<preConditions onFail="CONTINUE">
			<sqlCheck expectedResult="1">
				SELECT  count(property) from global_property WHERE property='order.drugDispensingUnitsConceptUuid';
			</sqlCheck>
		</preConditions>
		<comment>Setting Specimen source concept uuid</comment>
		<sql>
			UPDATE global_property SET property_value = '162402AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' WHERE property='order.drugDispensingUnitsConceptUuid';
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-12-02-2020-02" author="slubwama">
		<preConditions onFail="CONTINUE">
			<sqlCheck expectedResult="1">
				SELECT  count(property) from global_property WHERE property='order.drugDosingUnitsConceptUuid';
			</sqlCheck>
		</preConditions>
		<comment>Setting Specimen source concept uuid</comment>
		<sql>
			UPDATE global_property SET property_value = '162384AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' WHERE property='order.drugDosingUnitsConceptUuid';
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-06-11-2019-03" author="slubwama">
		<preConditions onFail="CONTINUE">
			<sqlCheck expectedResult="1">
				SELECT  count(property) from global_property WHERE property='order.drugRoutesConceptUuid';
			</sqlCheck>
		</preConditions>
		<comment>Setting Specimen source concept uuid</comment>
		<sql>
			UPDATE global_property SET property_value = '162394AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' WHERE property='order.drugRoutesConceptUuid';
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-06-11-2019-04" author="slubwama">
		<preConditions onFail="CONTINUE">
			<sqlCheck expectedResult="1">
				SELECT  count(property) from global_property WHERE property='order.durationUnitsConceptUuid';
			</sqlCheck>
		</preConditions>
		<comment>Setting Specimen source concept uuid</comment>
		<sql>
			UPDATE global_property SET property_value = '1732AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' WHERE property='order.durationUnitsConceptUuid';
		</sql>
	</changeSet>


	<changeSet id="ugandaemr-14-08-2020-04" author="dbaluku">
		<comment>Migrate data from concept id 90253 (HIV Status) to 165275 (Family Member HIV Status)
			unknown answer 90001 to 165165 in the on the ART Summary Page Family Tracking Section from 2.x to 3.x</comment>
		<sql>
			UPDATE obs SET concept_id = 165275 WHERE concept_id = 90253 and obs_group_id is not null;
			UPDATE obs SET value_coded=165165 WHERE concept_id = 165275 and value_coded=90001 and obs_group_id is not null;
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-27-10-2021-01" author="ssmusoke">
		<preConditions onFail="CONTINUE">
			<sqlCheck expectedResult="1">
				SELECT COUNT(program_workflow_state_id) FROM program_workflow_state  WHERE uuid = 'ab6d1f1d-fcf6-4255-8b6f-2bf8959ad8f2';
			</sqlCheck>
		</preConditions>
		<comment>Move all patients who have ever enrolled into care into the HIV program and set the state to UNKNOWN only after the state has been loaded </comment>
		<sql>
			<!-- move the patients to the HIV Program on the date that they were enrolled into care -->
			INSERT INTO patient_program (patient_id, program_id, date_enrolled, location_id, creator, date_created, voided, uuid)
			SELECT patient_id,(SELECT program.program_id FROM program WHERE program.uuid='18c6d4aa-0a36-11e7-8dbb-507b9dc4c741') AS program,encounter_datetime AS date_enrolled,location_id,encounter.creator,NOW(),0,UUID() AS uuid FROM encounter INNER JOIN encounter_type ON(encounter_type.encounter_type_id=encounter.encounter_type) WHERE  encounter_type.uuid='8d5b27bc-c2cc-11de-8d13-0010c6dffd0f' GROUP BY patient_id;

			<!-- set the initial state to First Line -->
			INSERT INTO patient_state(patient_program_id,state,start_date,creator,date_created,uuid)
			SELECT pp.patient_program_id, 11, pp.date_enrolled, 1, pp.date_enrolled, uuid() FROM patient_program pp, program p WHERE pp.program_id = p.program_id AND p.uuid = '18c6d4aa-0a36-11e7-8dbb-507b9dc4c741'
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-2021-03-15-1756" author="slubwama">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				SELECT COUNT(*) FROM global_property where property = "ugandaemr.dhis2.organizationuuid" AND property_value="eg d06ace3e-9c46-11e7-abc4-cec278b6b50a"
			</sqlCheck>
		</preConditions>
		<comment>Change the default value of the global property gandaemr.dhis2.organizationuuid from 'eg d06ace3e-9c46-11e7-abc4-cec278b6b50a' to an empty string</comment>
		<sql>
			UPDATE global_property SET property_value = ""  WHERE property = "ugandaemr.dhis2.organizationuuid" AND property_value="eg d06ace3e-9c46-11e7-abc4-cec278b6b50a"
		</sql>
	</changeSet> 
	<changeSet id="ugandaemr-14062021-1052" author="mmwanje">
		<comment>
			Changing Concept Name for concept 99302 from Fifty dose to Fifth dose
		</comment>
		<sql>
			UPDATE concept_name SET name = 'Fifth dose' WHERE concept_id =99302 AND concept_name_type ='FULLY_SPECIFIED'; 
     </sql>
	</changeSet>
	<changeSet id="ugandaemr-2021-04-30-1509" author="dbaluku">

		<comment>Add observations of transfer in date  and transfer out date for transfer in encounters and transfer out encounters respectively</comment>
		<sql>
			INSERT INTO obs (person_id, concept_id, encounter_id, obs_datetime, location_id,value_datetime, creator, date_created, voided, status,uuid) SELECT e.patient_id,99160,e.encounter_id,e.encounter_datetime,2,e.encounter_datetime,e.creator,e.date_created,0,'FINAL',uuid() FROM encounter e  inner join  encounter_type et on e.encounter_type = et.encounter_type_id WHERE et.uuid ='3e8354f7-31b3-4862-a52e-ff41a1ee60af' and e.voided =0;
			INSERT INTO obs (person_id, concept_id, encounter_id, obs_datetime, location_id,value_datetime, creator, date_created, voided, status,uuid) SELECT e.patient_id,99165,e.encounter_id,e.encounter_datetime,2,e.encounter_datetime,e.creator,e.date_created,0,'FINAL',uuid() FROM encounter e  inner join  encounter_type et on e.encounter_type = et.encounter_type_id WHERE et.uuid ='e305d98a-d6a2-45ba-ba2a-682b497ce27c' and e.voided =0;
 
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-20210813-0923" author="dbaluku">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				SELECT COUNT(*) from scheduler_task_config WHERE uuid ='415b8d70-6b45-41d8-a0ba-41b1a6b8aa1f'
			</sqlCheck>
		</preConditions>
		<comment>Delete TB Lost to Followup Exit Task</comment>
		<sql>
			DELETE FROM scheduler_task_config WHERE uuid = '415b8d70-6b45-41d8-a0ba-41b1a6b8aa1f';
		</sql>
	</changeSet>
	<changeSet id="ugandaemr-20210823-0915" author="dbaluku">
		<comment>Insert Cohort type for CDDP Group </comment>
		<sql>
			REPLACE INTO cohort_type(name,date_created,creator,uuid)VALUES
			('CRPDDP Cohort Type','2021-08-23',1,'e50fa0af-df36-4a26-853f-feb05244e5ca'),
			('CLDDP Cohort Type','2021-08-23',1,'aa536e57-a3c3-453c-9413-cf70b5d2ad5d'),
			('CCLAD Cohort Type','2021-08-23',1,'5b7136fa-d207-4229-94a8-da6661ae00bf');
		</sql>
	</changeSet>
	<changeSet id="ugandaemr-11-08-2023" author="odorajonathan">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				SELECT COUNT(*) from location WHERE uuid = '8f96e239-8586-4ec6-9375-04c6e19628ae';
			</sqlCheck>
		</preConditions>
		<comment>
			Retire SMC Clinic
		</comment>
		<sql>
			UPDATE location SET retired = 1 WHERE uuid = '8f96e239-8586-4ec6-9375-04c6e19628ae';
     </sql>
	</changeSet>
	<changeSet id="ugandaemr-01032022-1401" author="dbaluku">
		<comment>
			Updating encounters and obs that were created with location_id set a null to  ART Clinic location
		</comment>
		<sql>
			UPDATE encounter SET location_id = (select location_id from location where uuid='86863db4-6101-4ecf-9a86-5e716d6504e4') WHERE location_id IS null;
			UPDATE obs SET location_id = (select location_id from location where uuid='86863db4-6101-4ecf-9a86-5e716d6504e4') WHERE location_id IS null;
		</sql>
	</changeSet>
	<changeSet id="ugandaemr-20220323-1015" author="dbaluku">
		<comment>Insert Cohort type for SMS Cohort and SMS Cohorts </comment>
		<sql>
			REPLACE INTO cohort_type(name,date_created,creator,uuid)VALUES
			('SMS Cohort Type','2022-03-23',1,'889aa250-7113-4ba7-ab8c-ca062e004696');

			REPLACE INTO cohort(name,date_created,creator,uuid,cohort_type_id)VALUES
			('SMS Appointment Reminder','2022-03-23',1,'c418984c-fe55-431a-90be-134da0a5ec67',(SELECT cohort_type_id from cohort_type where uuid='889aa250-7113-4ba7-ab8c-ca062e004696')),
			('SMS Non Suppressed ViralLoad ','2022-03-23',1,'f538f903-0258-4151-a4f6-f8ceb8046017',(SELECT cohort_type_id from cohort_type where uuid='889aa250-7113-4ba7-ab8c-ca062e004696'));
		</sql>
	</changeSet>


	<changeSet author="slubwama" id="order-obs-202303081017-1">
		<createTable tableName="order_obs">
			<column autoIncrement="true" name="order_obs_id" type="INT">
				<constraints primaryKey="true" unique="true"/>
			</column>
			<column name="order_id" type="INT"/>
			<column name="obs_id" type="INT"/>
			<column name="encounter_id" type="INT"/>
			<column name="date_created" type="datetime"/>
			<column name="changed_by" type="INT"/>
			<column name="date_changed" type="datetime"/>
			<column name="voided" type="TINYINT(3)"/>
			<column name="date_voided" type="datetime"/>
			<column name="voided_by" type="INT"/>
			<column name="void_reason" type="VARCHAR(255)"/>
			<column name="creator" type="INT"/>
			<column name="uuid" type="VARCHAR(38)"/>
		</createTable>
	</changeSet>

	<changeSet author="slubwama" id="order_obs_202303081017-2">
		<createIndex indexName="order_obs_encounter_id_index" tableName="order_obs">
			<column name="encounter_id"/>
		</createIndex>
	</changeSet>

	<changeSet author="slubwama" id="order_obs_202303081017-3">
		<addForeignKeyConstraint baseColumnNames="encounter_id" baseTableName="order_obs" constraintName="order_obs_encounter_id_index" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="encounter_id" referencedTableName="encounter"/>
	</changeSet>

	<changeSet author="slubwama" id="order_obs_202303081017-4">
		<createIndex indexName="order_obs_orders_order_id_fk" tableName="order_obs">
			<column name="order_id"/>
		</createIndex>
	</changeSet>

	<changeSet author="slubwama" id="order_obs_202303081017-5">
		<addForeignKeyConstraint baseColumnNames="order_id" baseTableName="order_obs" constraintName="order_obs_orders_order_id_fk" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="order_id" referencedTableName="orders"/>
	</changeSet>

	<changeSet author="slubwama" id="order_obs_202303081017-6">
		<createIndex indexName="order_obs_obs_obs_id_fk" tableName="order_obs">
			<column name="obs_id"/>
		</createIndex>
	</changeSet>

	<changeSet author="slubwama" id="order_obs_202303081017-7">
		<addForeignKeyConstraint baseColumnNames="obs_id" baseTableName="order_obs" constraintName="order_obs_obs_obs_id_fk" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="obs_id" referencedTableName="obs"/>
	</changeSet>

	<changeSet author="slubwama" id="order_obs_202303081017-8">
		<addUniqueConstraint columnNames="obs_id,order_id" constraintName="order_obs_order_id_obs_id_uindex" tableName="order_obs"/>
	</changeSet>

	<changeSet  author="slubwama" id="ugandaemr-2023-03-08-1712">
		<comment>add test orders with results into the order_obs table</comment>
		<sql>
			replace into order_obs (encounter_id, order_id, obs_id, date_created, creator, uuid) (select encounter_id, order_id, obs_id, date_created, creator, uuid() from obs where order_id is not null);
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-20230127-2345" author="daphinenalule">
		<comment>
			Insert General CDDP Cohort type for CDDP Group
		</comment>
		<sql>
			REPLACE INTO cohort_type(name,date_created,creator,uuid)VALUES
			('General CDDP Cohort Type','2023-01-27',1,'da964ff0-648e-440b-a219-d2aeba3670d0');
		</sql>
	</changeSet>

	<changeSet id="20230404-1001" author="iakileng">
		<preConditions onFail="MARK_RAN">
			<tableExists tableName="obs"/>
		</preConditions>
		<comment> Updating family member's hiv unknown status concept id in obs table </comment>
		<sql> UPDATE obs SET value_coded = 90001 where value_coded = 165165 and concept_id = 165275; </sql>
	</changeSet>
	<changeSet id="ugandaemr-20230413-1122" author="semujju">
		<comment>
			Change htmlformentry_html_form table to UTF-8 encoding
		</comment>
		<sql>
			ALTER TABLE htmlformentry_html_form CONVERT TO CHARACTER SET UTF8;
		</sql>
	</changeSet>
	<changeSet id="ugandaemr-20230425-1730" author="dbaluku">
		<comment>
			next gen reports uuids for exchange
		</comment>
		<sql>
			UPDATE global_property SET property_value = '214fb8ef-6219-43f3-b20b-023261c0dec6,8dafdc32-97b7-4f49-828e-475cd4f09669,65fec0844-1970-43c5-bf77-b296415daa34,e7102e5c-b90d-4a4a-b763-20518eadbae5' WHERE property = 'ugandaemrsync.sendNextGenReports.server.reportuuids';
			UPDATE global_property SET property_value = '27f4804f-ec6f-466e-b4ea-21f9ca584880,072b526a-4140-4c43-9f5c-6d1fa74d7c42,0e3bdfde-3ee0-4f94-b105-bff844feba30,a2d6170e-1930-4f21-920c-6106e39058e8,ac1b2145-54aa-4ed8-9590-db7c47fe51e4' WHERE property = 'ugandaemrsync.sendHMISReports.server.reportuuids';
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-01-01-2024-0010" author="iakileng">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">
				SELECT COUNT(*) FROM
				metadatamapping_metadata_set_member WHERE metadata_uuid ='be8f222a-3751-4f93-8c74-3aff399c19b6';
			</sqlCheck>
			<sqlCheck expectedResult="0">
				SELECT COUNT(*) FROM
				metadatamapping_metadata_set_member WHERE uuid ='2fcc3a81-0500-47df-88bd-c0a56d113662';
			</sqlCheck>
			<sqlCheck expectedResult="1">
				SELECT COUNT(*) FROM patient_identifier_type WHERE uuid="be8f222a-3751-4f93-8c74-3aff399c19b6";
			</sqlCheck>
		</preConditions>
		<comment> Enabling OPD Number to be displayed in UgandaEMR on a patient dashboard </comment>
		<sql>
			INSERT INTO metadatamapping_metadata_set_member (metadata_set_id, metadata_class, metadata_uuid, sort_weight, name, description, creator, date_created, changed_by, date_changed, retired, date_retired, retired_by, retire_reason, uuid)
			SELECT 1, 'org.openmrs.PatientIdentifierType', 'be8f222a-3751-4f93-8c74-3aff399c19b6',null, null, null, 2, NOW(), null, null, 0, null, null, null,'2fcc3a81-0500-47df-88bd-c0a56d113662';
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-2023-08-30-0828" author="slubwama">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				SELECT COUNT(*) FROM concept_name WHERE concept_name_id> 7000000 limit 1;
			</sqlCheck>
		</preConditions>
		<comment> Change concept names from a big number to a normal increment number</comment>
		<sql>
			update concept_name set concept_name_id=(concept_name_id-7187255) where concept_name_id>7000000;
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-20240228-1080" author="mmwanje">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">
				SELECT COUNT(*) FROM cohort_type WHERE uuid='1345c89c-8463-41e9-9cd0-8c14aa255ba8';
			</sqlCheck>
		</preConditions>
		<comment>Insert Cohort type for Eligibility Cohort and eligible Cohorts </comment>
		<sql>
			REPLACE INTO cohort_type(name,date_created,creator,uuid)VALUES
			('Eligibility Cohort Type','2024-02-28',1,'1345c89c-8463-41e9-9cd0-8c14aa255ba8');

			REPLACE INTO cohort(name,description, date_created,creator,uuid,cohort_type_id)VALUES
			('HIV Program','Eligible', '2024-02-28', 1, '56b082f8-f956-499d-a8c2-d9b32a067e65',(SELECT cohort_type_id from cohort_type where uuid='1345c89c-8463-41e9-9cd0-8c14aa255ba8')),
			('TB Program','Eligible','2024-02-28',1,'0aa9ba5f-d44a-4b31-aff1-3a046bd8e5e0',(SELECT cohort_type_id from cohort_type where uuid='1345c89c-8463-41e9-9cd0-8c14aa255ba8')),
			('MCH Program','Eligible', '2024-02-28', 1, 'd861187f-e25a-493b-81b1-b2a4c4679b7a',(SELECT cohort_type_id from cohort_type where uuid='1345c89c-8463-41e9-9cd0-8c14aa255ba8')),
			('Nutrition Program','Eligible', '2024-02-28',1,'2827e1b5-be8a-4c1d-afc7-f6afcc4f2537',(SELECT cohort_type_id from cohort_type where uuid='1345c89c-8463-41e9-9cd0-8c14aa255ba8'));
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-28022024-1032" author="mmwanje">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">
				SELECT COUNT(*) FROM scheduler_task_config
				WHERE schedulable_class = 'org.openmrs.module.ugandaemr.tasks.IdentifyCohortMemberOfProgramsAndWorkflowsTask'
			</sqlCheck>
		</preConditions>
		<sql>DELETE FROM scheduler_task_config where uuid='3b8355ba-1f6e-4773-b95a-6101974ed462'</sql>
		<comment>Inserting Eligibility Cohort Task into 'schedule_task_config' table</comment>
		<insert tableName="scheduler_task_config">
			<column name="name" value="Eligibility Cohort Task" />
			<column name="description" value="Identify and add eligible members into the cohort" />
			<column name="schedulable_class" value="org.openmrs.module.ugandaemr.tasks.IdentifyCohortMemberOfProgramsAndWorkflowsTask" />
			<column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
			<column name="start_time" valueDate="2024-02-28T05:59:59" />
			<column name="repeat_interval" value="86400" />
			<column name="date_created" valueDate="CURRENT_TIMESTAMP" />
			<column name="created_by" value="1" />
			<column name="start_on_startup" value="1"/>
			<column name="started" value="1"/>
			<column name="uuid" value="3b8355ba-1f6e-4773-b95a-6101974ed462" />
		</insert>
	</changeSet>

	<changeSet id="ugandaemr-20240314-1654" author="slubwama">
		<preConditions onFail="CONTINUE">
			<sqlCheck expectedResult="1">
				select count(*) from appointment_service where uuid="348e1cba-ffd4-4994-be3d-cd409d190b9f";
			</sqlCheck>
		</preConditions>
		<comment>Migrate patient appointments from observations to patient calender</comment>
		<sql>
			INSERT INTO patient_appointment (appointment_number, patient_id, start_date_time, end_date_time, appointment_service_id, status, location_id, appointment_kind, uuid, date_created, creator,voided)
			select '0000',person_id,value_datetime,value_datetime,2,'Requested',location_id,'Scheduled',uuid(),obs_datetime,1,0 from obs where concept_id=5096 and voided=false;

			UPDATE patient_appointment a INNER JOIN obs b ON a.patient_id = b.person_id SET appointment_service_id = 3 WHERE  b.concept_id=160288 and value_coded=856;
			UPDATE patient_appointment a INNER JOIN obs b ON a.patient_id = b.person_id SET appointment_service_id = 13 WHERE  b.concept_id=160288 and value_coded=903;
			UPDATE patient_appointment a INNER JOIN obs b ON a.patient_id = b.person_id SET appointment_service_id = 5 WHERE  b.concept_id=160288 and value_coded=5484;
			UPDATE patient_appointment a INNER JOIN obs b ON a.patient_id = b.person_id SET appointment_service_id = 12 WHERE  b.concept_id=160288 and value_coded=90012;
			UPDATE patient_appointment a INNER JOIN obs b ON a.patient_id = b.person_id SET appointment_service_id = 6 WHERE  b.concept_id=160288 and value_coded=99324;
			UPDATE patient_appointment a INNER JOIN obs b ON a.patient_id = b.person_id SET appointment_service_id = 4 WHERE  b.concept_id=160288 and value_coded=164968;
			UPDATE patient_appointment a INNER JOIN obs b ON a.patient_id = b.person_id SET appointment_service_id = 9 WHERE  b.concept_id=160288 and value_coded=164970;
			UPDATE patient_appointment a INNER JOIN obs b ON a.patient_id = b.person_id SET appointment_service_id = 11 WHERE  b.concept_id=160288 and value_coded=164971;
			UPDATE patient_appointment a INNER JOIN obs b ON a.patient_id = b.person_id SET appointment_service_id = 2 WHERE  b.concept_id=160288 and value_coded=164972;
			UPDATE patient_appointment a INNER JOIN obs b ON a.patient_id = b.person_id SET appointment_service_id = 8 WHERE  b.concept_id=160288 and value_coded=164974;
			UPDATE patient_appointment a INNER JOIN obs b ON a.patient_id = b.person_id SET appointment_service_id = 7 WHERE  b.concept_id=160288 and value_coded=163153;
			UPDATE patient_appointment a INNER JOIN obs b ON a.patient_id = b.person_id SET appointment_service_id = 10 WHERE  b.concept_id=160288 and value_coded=164973;
		</sql>
	</changeSet>
    <changeSet id="ugandaemr-20240314-1821" author="slubama">
        <preConditions onFail="CONTINUE">
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM provider_attribute_type WHERE uuid='13a721e4-68e5-4f7a-8aee-3cbcec127179';
            </sqlCheck>

            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM cohort_type WHERE uuid='1345c89c-8463-41e9-9cd0-8c14aa255ba8';
            </sqlCheck>
        </preConditions>
        <comment>Default all users to the ART clinic except for the admin and demon. </comment>
        <sql>
            INSERT INTO provider_attribute ( provider_id, attribute_type_id, value_reference, uuid, creator, date_created,voided)
            SELECT provider_id, (select provider_attribute_type_id from provider_attribute_type where uuid="13a721e4-68e5-4f7a-8aee-3cbcec127179"),'86863db4-6101-4ecf-9a86-5e716d6504e4', uuid(), 1, date_created,0 from provider where person_id not in (1);
        </sql>
    </changeSet>


	<changeSet id="ugandaemr-20240317-1406" author="slubwama">
		<preConditions onFail="CONTINUE">
			<sqlCheck expectedResult="1">
				select count(*) from concept where concept_id=159959;
			</sqlCheck>
		</preConditions>
		<comment>Move all obs of specimen source that have concept 162476 which is of data type N/A to  159959 of data type coded</comment>
		<sql>
			update obs set concept_id=159959 where concept_id=162476;
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-20240316-1654" author="slubwama">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				select count(*) from patient_identifier_type where uuid="877169c4-92c6-4cc9-bf45-1ab95faea242";
			</sqlCheck>
		</preConditions>
		<comment>Make UIC not unique to support the generation its generation in-spite of duplicates</comment>
		<sql>
			UPDATE patient_identifier_type set uniqueness_behavior="NON_UNIQUE" where uuid="877169c4-92c6-4cc9-bf45-1ab95faea242";
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-20240406-1654" author="slubwama">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				select count(*) from drug where drug_id=164;
			</sqlCheck>
		</preConditions>
		<comment>change drugs Efavirenz from a capsule to a tablet</comment>
		<sql>
			UPDATE drug SET name = 'Efavirenz Tablet 200 mg', dosage_form = 1513 WHERE drug_id = 164
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-20240408-1655" author="slubwama">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				select count(*) from drug where drug_id=3 and name ="Abacavir sulfate Tablet 300 mg" and concept_id=165507;
			</sqlCheck>
		</preConditions>
		<comment>Change Abacavir sulfate Tablet 300 mg (Bisoprolol) CHANGE TO Abacavir 300mg</comment>
		<sql>
			UPDATE drug SET name = 'Abacavir 300 mg', dosage_form = 1513,concept_id = 814 WHERE drug_id = 3 and concept_id=165507;
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-20240411-1655" author="slubwama">
		<preConditions onFail="CONTINUE">
			<sqlCheck expectedResult="1">
				select count(*) from concept where concept_id=175384;
			</sqlCheck>
		</preConditions>
		<comment>Migrate data from other patient decision concept to rightful TB refferrall concept</comment>
		<sql>
			UPDATE obs SET concept_id = 175384 where concept_id=164435;
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-20240724-1455-01" author="slubwama">
		<preConditions onFail="CONTINUE">
			<sqlCheck expectedResult="1">
				select count(*)  from concept_set where date_created="2024-01-10 13:18:43" and concept_set=175279;
			</sqlCheck>
			<sqlCheck expectedResult="1">
				select count(*)  from concept_name where date_created="2023-11-08 13:34:24";
			</sqlCheck>
			<sqlCheck expectedResult="1">
				select count(*) from concept_name where concept_id=169007;
			</sqlCheck>
			<sqlCheck expectedResult="1">
				select count(*)  from concept_description where concept_id in (169014,169015,169016,169017,169018,169019,169020);
			</sqlCheck>
			<sqlCheck expectedResult="1">
				select count(*) from concept where concept.date_created="2023-11-07 12:59:26";
			</sqlCheck>
			<sqlCheck expectedResult="1">
				select count(*) from concept where concept.date_created="2023-11-08 09:19:30";
			</sqlCheck>
		</preConditions>
		<comment>Delete previous cause of death concepts</comment>
		<sql>
			delete  from concept_set where date_created="2024-01-10 13:18:43" and concept_set=175279;
			delete from concept_name where date_created="2023-11-08 13:34:24";
			delete from concept_name where concept_id=169007;
			delete  from concept_description where concept_id in (169014,169015,169016,169017,169018,169019,169020);
			delete from concept where concept.date_created="2023-11-07 12:59:26";
			delete from concept where concept.date_created="2023-11-08 09:19:30";
		</sql>
	</changeSet>

    <changeSet id="ugandaemr-20240624-0535" author="slubwama">
        <preConditions onFail="CONTINUE">
			<sqlCheck expectedResult="0">
				select count(*) from liquibasechangelog where ID="ugandaemr-20240318-1654";
			</sqlCheck>

            <sqlCheck expectedResult="1">
                select count(*) from program where uuid="18c6d4aa-0a36-11e7-8dbb-507b9dc4c741" and program_id=1;
            </sqlCheck>

            <sqlCheck expectedResult="1">
                select count(*) from program where uuid="de5d54ae-c304-11e8-9ad0-529269fb1459" and program_id=5;
            </sqlCheck>

            <sqlCheck expectedResult="1">
                select count(*) from program where uuid="de5d5b34-c304-11e8-9ad0-529269fb1459" and program_id=6;
            </sqlCheck>

            <sqlCheck expectedResult="1">
                select count(*) from program where uuid="de5d5896-c304-11e8-9ad0-529269fb1459" and program_id=7;
            </sqlCheck>

            <sqlCheck expectedResult="1">
                select count(*) from program where uuid="de5d5da0-c304-11e8-9ad0-529269fb1459" and program_id=8;
            </sqlCheck>

            <sqlCheck expectedResult="1">
                select count(*) from program where uuid="de5d6034-c304-11e8-9ad0-529269fb1459" and program_id=9;
            </sqlCheck>

            <sqlCheck expectedResult="1">
                select count(*) from program_workflow where uuid="b8d44412-9d8a-422f-8952-7fe15997f8b6";
            </sqlCheck>

            <sqlCheck expectedResult="1">
                select count(*) from program_workflow_state where uuid="4eae684a-ee1f-4f62-87f3-e3e58c91f417";
            </sqlCheck>

            <sqlCheck expectedResult="1">
                select count(*) from program_workflow_state where uuid="6b4906b1-388c-4984-974a-81e6f86f7737";
            </sqlCheck>

            <sqlCheck expectedResult="1">
                select count(*) from program_workflow_state where uuid="5e122a20-3e23-4e65-bb1b-9f1324f97396";
            </sqlCheck>

            <sqlCheck expectedResult="1">
                select count(*) from program_workflow_state where uuid="0ca3db87-567f-4159-acc0-0ec14d0b8036";
            </sqlCheck>

            <sqlCheck expectedResult="1">
                select count(*) from program_workflow_state where uuid="7e2acb9c-25e9-4b8f-b012-8436051d5c32";
            </sqlCheck>
        </preConditions>
        <comment>Migrate DSDM Programs into DSDM Workflows</comment>
        <sql>
            INSERT INTO patient_state (patient_program_id, state, start_date, end_date, creator, date_created, changed_by, date_changed, voided, voided_by, date_voided, void_reason, uuid)
            SELECT patient_program_id, 17 as state,pp.date_enrolled as start_date,pp.date_completed as end_date,pp.creator,pp.date_created,pp.changed_by,pp.date_changed,pp.voided,pp.voided_by, pp.date_voided,pp.void_reason,uuid() from patient_program pp where program_id=5;

            INSERT INTO patient_state (patient_program_id, state, start_date, end_date, creator, date_created, changed_by, date_changed, voided, voided_by, date_voided, void_reason, uuid)
            SELECT patient_program_id, 18,pp.date_enrolled,pp.date_completed,pp.creator,pp.date_created,pp.changed_by,pp.date_changed,pp.voided,pp.voided_by, pp.date_voided,pp.void_reason,uuid() from patient_program pp where program_id=6;

            INSERT INTO patient_state (patient_program_id, state, start_date, end_date, creator, date_created, changed_by, date_changed, voided, voided_by, date_voided, void_reason, uuid)
            SELECT patient_program_id, 19,pp.date_enrolled,pp.date_completed,pp.creator,pp.date_created,pp.changed_by,pp.date_changed,pp.voided,pp.voided_by, pp.date_voided,pp.void_reason,uuid() from patient_program pp where program_id=7;

            INSERT INTO patient_state (patient_program_id, state, start_date, end_date, creator, date_created, changed_by, date_changed, voided, voided_by, date_voided, void_reason, uuid)
            SELECT patient_program_id, 20,pp.date_enrolled,pp.date_completed,pp.creator,pp.date_created,pp.changed_by,pp.date_changed,pp.voided,pp.voided_by, pp.date_voided,pp.void_reason,uuid() from patient_program pp where program_id=8;

            INSERT INTO patient_state (patient_program_id, state, start_date, end_date, creator, date_created, changed_by, date_changed, voided, voided_by, date_voided, void_reason, uuid)
            SELECT patient_program_id, 21,pp.date_enrolled,pp.date_completed,pp.creator,pp.date_created,pp.changed_by,pp.date_changed,pp.voided,pp.voided_by, pp.date_voided,pp.void_reason,uuid() from patient_program pp where program_id=9;

            CREATE TEMPORARY TABLE IF NOT EXISTS dsdm_patient_programs AS (select  patient_program.*,state,patient_state_id from patient_program inner join patient_state on patient_program.patient_program_id = patient_state.patient_program_id where program_id in (5,6,7,8,9));
            CREATE TEMPORARY TABLE IF NOT EXISTS hiv_program AS (select  patient_program.*,state from patient_program inner join patient_state on patient_program.patient_program_id = patient_state.patient_program_id where program_id in (1));
            CREATE TEMPORARY TABLE IF NOT EXISTS dsdm_hiv_program_match  AS (select patient_state_id as matching_patient_state_id ,dsdm_patient_programs.patient_program_id asdsdm_patient_program_id , hiv_program.patient_program_id  as hiv_patient_program_id,dsdm_patient_programs.patient_program_id as dsdm_patient_program_id ,dsdm_patient_programs.patient_id as dsdm_patient from hiv_program inner join dsdm_patient_programs on (hiv_program.patient_id=dsdm_patient_programs.patient_id) where dsdm_patient_programs.state in (17,18,19,20,21));

            UPDATE patient_state
            INNER JOIN dsdm_hiv_program_match
            ON dsdm_hiv_program_match.matching_patient_state_id = patient_state.patient_state_id
            SET patient_state.patient_program_id = dsdm_hiv_program_match.hiv_patient_program_id
            WHERE patient_state.state in (17,18,19,20,21);

            update program_workflow set program_id=1 where program_workflow.program_id=9 and program_workflow_id=4;

            drop table dsdm_patient_programs;
            drop table hiv_program;
            drop table dsdm_hiv_program_match;

            UPDATE patient_program AS pp
            SET pp.voided = true,
            pp.voided_by = 1,
            pp.date_voided = now(),
            pp.void_reason = "Migrated to DSDM workflow from DSDM Program"
            WHERE pp.program_id IN (5,6,7,8,9);
        </sql>
    </changeSet>

	<changeSet id="ugandaemr-20240610-1655" author="slubwama">
		<preConditions onFail="CONTINUE">
			<sqlCheck expectedResult="1">
				select count(*) from concept where uuid="7cac8397-53cd-4f00-a6fe-028e8d743f8e";
			</sqlCheck>
		</preConditions>
		<comment>Change Image attachment to known concept metadata in UgandaEMR</comment>
		<sql>
			update concept_name set concept_name.uuid="552e757e-b072-4e68-a10d-b7db7efcd5ad", concept_name.concept_name_id=198844, concept_name.concept_id=186351  where concept_id in (select concept.concept_id from  concept where concept.uuid="7cac8397-53cd-4f00-a6fe-028e8d743f8e");
			update concept set concept_id=186351 where uuid="7cac8397-53cd-4f00-a6fe-028e8d743f8e";
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-20240610-1656" author="slubwama">
		<preConditions onFail="CONTINUE">
			<sqlCheck expectedResult="1">
				select count(*) from concept where uuid="42ed45fd-f3f6-44b6-bfc2-8bde1bb41e00";
			</sqlCheck>
		</preConditions>
		<comment>Change Default attachment to known concept metadata in UgandaEMR</comment>
		<sql>
			update concept_name set concept_name.uuid="209ebadb-d3df-489a-bd10-7171e21c4869", concept_name.concept_name_id=198845, concept_name.concept_id=186352  where concept_id in (select concept.concept_id from  concept where concept.uuid="42ed45fd-f3f6-44b6-bfc2-8bde1bb41e00");
			update concept set concept_id=186352 where uuid="42ed45fd-f3f6-44b6-bfc2-8bde1bb41e00";
		</sql>
	</changeSet>

	<changeSet id="ugandaemr-20241015-1111" author="mmwanje">
		<preConditions onFail="CONTINUE">
			<tableExists tableName="bed"/>
			<tableExists tableName="bed_location_map"/>
			<tableExists tableName="bed_patient_assignment_map"/>
			<tableExists tableName="bed_tag"/>
			<tableExists tableName="bed_tag_map"/>
			<tableExists tableName="bed_type"/>
		</preConditions>

		<comment>Dropping bed management module related tables</comment>

		<sql>SET FOREIGN_KEY_CHECKS=0;</sql>
		<dropTable tableName="bed"/>
		<dropTable tableName="bed_location_map"/>
		<dropTable tableName="bed_patient_assignment_map"/>
		<dropTable tableName="bed_tag"/>
		<dropTable tableName="bed_tag_map"/>
		<dropTable tableName="bed_type"/>
		<sql>SET FOREIGN_KEY_CHECKS=1;</sql>
	</changeSet>

</databaseChangeLog>


